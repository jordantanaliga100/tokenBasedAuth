<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Dashboard</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />
    <style>
      .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="container mt-5">
      <h1 class="mb-4">Welcome to the Dashboard!</h1>

      <% if (user) { %>
      <div class="card p-3 mb-4">
        <h2>Hello, <%= user.username || user.email %> ðŸ‘‹</h2>
        <p><strong>User ID:</strong> <%= user.id %></p>
        <p><strong>Email:</strong> <%= user.email %></p>
      </div>
      <% } else { %>
      <div class="alert alert-warning">You are not logged in.</div>
      <% } %>

      <a href="/" id="logout-btn" class="btn btn-danger">Logout</a>
    </div>

    <script>
      function showToast(message, type = "info") {
        const toast = document.createElement("div");
        toast.className = `alert alert-${type} position-fixed`;
        toast.style.cssText =
          "top: 20px; right: 20px; z-index: 9999; min-width: 250px;";
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
          toast.remove();
        }, 3000);
      }

      // Also check on page load ðŸ”¥
      document.addEventListener("DOMContentLoaded", async () => {
        const res = await fetch("/api/v1/auth/me", {
          credentials: "include",
        });

        if (res.status === 401) {
          window.location.href = "/login";
        }
      });
      // Check session status every 30 seconds ðŸ”¥
      setInterval(async () => {
        try {
          const res = await fetch("/api/v1/auth/me", {
            credentials: "include",
          });

          if (res.status === 401) {
            showToast("Session expired, redirecting to login...", "warning");
            setTimeout(() => {
              window.location.href = "/login";
            }, 1500);
          }
        } catch (error) {
          showToast("Connection error, please refresh", "danger");
        }
      }, 1500);
      document
        .getElementById("logout-btn")
        .addEventListener("click", async (e) => {
          e.preventDefault();

          const res = await fetch("/api/v1/auth/logout", {
            method: "GET",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
          });

          const data = await res.json();

          if (res.ok) {
            // Redirect to login page after success
            window.location.href = "/login";
          } else {
            document.getElementById("error").innerText =
              data.message || "Registration failed!";
          }
        });
    </script>
  </body>
</html>
